nodesets:
  enabled: true

  interval: 5m
  timeout: 5m
  version: 3.0.0
  namespace: soperator
  releaseName: soperator-nodesets

  overrideValues: 
    nodesets:
      - name: worker
        annotations:
          slurm.nebius.ai/parental-cluster-ref: soperator

        replicas: 2
        maxUnavailable: 20%

        gpu:
          enabled: true
          nvidia:
            gdrCopyEnabled: true

        nodeConfig:
          features:
            - gpu_h100_sxm
            - network_ssd
          static: "CPUs=128 Boards=1 SocketsPerBoard=2 CoresPerSocket=32 ThreadsPerCore=2 Gres=gpu:nvidia_h100_80gb_hbm3:8"
          dynamic: "\"{ \\\"monitoring\\\": \\\"https://console.eu.nebius.com/project-e00vf634pr00ysynsawwsj/compute/instances/$INSTANCE_ID/monitoring\\\" }\""
          gresConfig:
            - AutoDetect=off Name=gpu Type=nvidia_h100_80gb_hbm3 File=/dev/nvidia0 Cores=32-63 Links=1,1,1,1,-1,1,1,1 Flags=nvidia_gpu_env
            - AutoDetect=off Name=gpu Type=nvidia_h100_80gb_hbm3 File=/dev/nvidia1 Cores=32-63 Links=1,1,1,1,1,-1,1,1 Flags=nvidia_gpu_env
            - AutoDetect=off Name=gpu Type=nvidia_h100_80gb_hbm3 File=/dev/nvidia2 Cores=32-63 Links=1,1,1,1,1,1,-1,1 Flags=nvidia_gpu_env
            - AutoDetect=off Name=gpu Type=nvidia_h100_80gb_hbm3 File=/dev/nvidia3 Cores=32-63 Links=1,1,1,1,1,1,1,-1 Flags=nvidia_gpu_env
            - AutoDetect=off Name=gpu Type=nvidia_h100_80gb_hbm3 File=/dev/nvidia4 Cores=0-31 Links=-1,1,1,1,1,1,1,1 Flags=nvidia_gpu_env
            - AutoDetect=off Name=gpu Type=nvidia_h100_80gb_hbm3 File=/dev/nvidia5 Cores=0-31 Links=1,-1,1,1,1,1,1,1 Flags=nvidia_gpu_env
            - AutoDetect=off Name=gpu Type=nvidia_h100_80gb_hbm3 File=/dev/nvidia6 Cores=0-31 Links=1,1,-1,1,1,1,1,1 Flags=nvidia_gpu_env
            - AutoDetect=off Name=gpu Type=nvidia_h100_80gb_hbm3 File=/dev/nvidia7 Cores=0-31 Links=1,1,1,-1,1,1,1,1 Flags=nvidia_gpu_env

        slurmd:
          resources:
            cpu: 127000m
            memory: 1438Gi
            ephemeralStorage: 387Gi
            gpu: 8

          volumes:
            spool:
              emptyDir: {}

            jail:
              persistentVolumeClaim:
                claimName: jail-pvc
                readOnly: false

            jailSubMounts:

              - name: home-dir
                mountPath: /home
                volumeSource:
                  persistentVolumeClaim:
                    claimName: home-dir

              - name: data
                mountPath: /mnt/data
                volumeSource:
                  persistentVolumeClaim:
                    claimName: jail-submount-data-pvc
                    readOnly: false

              - name: local-data
                mountPath: /mnt/local-data
                volumeClaimTemplateSpec:
                  accessModes:
                    - ReadWriteOnce
                  storageClassName: compute-csi-network-ssd-ext4
                  resources:
                    requests:
                      storage: 1024Gi

              - name: image-storage
                mountPath: /mnt/image-storage
                volumeClaimTemplateSpec:
                  accessModes:
                    - ReadWriteOnce
                  storageClassName: compute-csi-network-ssd-io-m3-ext4
                  resources:
                    requests:
                      storage: 930Gi

            customVolumeMounts:
              - name: slurm-scripts
                mountPath: /opt/slurm_scripts/
                volumeSource:
                  configMap:
                    name: slurm-scripts
                    defaultMode: 500

              - name: slurm-scripts-jail
                mountPath: /mnt/jail.upper/opt/slurm_scripts/
                volumeSource:
                  configMap:
                    name: slurm-scripts
                    defaultMode: 500

              - name: sys-host
                mountPath: /mnt/jail.upper/sys-host
                readOnly: true
                volumeSource:
                  hostPath:
                    path: /sys
                    type: Directory

              - name: enroot-on-image-storage
                mountPath: /etc/enroot/enroot.conf.d/custom-dirs.conf
                subPath: enroot.conf
                readOnly: true
                volumeSource:
                  configMap:
                    name: image-storage
                    defaultMode: 500

              - name: docker-on-image-storage
                mountPath: /etc/docker/daemon.json
                subPath: daemon.json
                readOnly: true
                volumeSource:
                  configMap:
                    name: image-storage
                    defaultMode: 500

              - name: hpc-jobs-dir
                mountPath: /var/run/nebius/slurm
                volumeSource:
                  hostPath:
                    path: /var/run/nebius/slurm
                    type: DirectoryOrCreate

              - name: nvidia-driver-root
                mountPath: /run/nvidia/driver
                readOnly: false
                volumeSource:
                  hostPath:
                    path: /
                    type: ""

            sharedMemorySize: 1024Gi

          security:
            appArmorProfile: unconfined

        munge:
          resources:
            cpu: 100m
            memory: 0.5Gi
            ephemeralStorage: 5Gi

          security:
            appArmorProfile: unconfined

        configMapRefSupervisord: custom-supervisord-config
        configMapRefSshd: 

        enableHostUserNamespace: true

        priorityClass: soperator-worker-high-priority
        nodeSelector:
          slurm.nebius.ai/nodeset-name: worker
        tolerations:
          - key: nvidia.com/gpu
            operator: Exists
            effect: NoSchedule

        customInitContainers:
          - name: ensure-jail-virtiofs
            image: cr.eu-north1.nebius.cloud/soperator/busybox
            volumeMounts: [{ name: jail, mountPath: /volume-mount }]
            command: ["grep", " /volume-mount virtiofs ", "/proc/mounts"]

          - name: ensure-jail-submount-data-virtiofs
            image: cr.eu-north1.nebius.cloud/soperator/busybox
            volumeMounts: [{ name: 'data', mountPath: /volume-mount }]
            command: ["grep", " /volume-mount virtiofs ", "/proc/mounts"]

          - name: ensure-node-local-jail-submount-local-data-ext4
            image: cr.eu-north1.nebius.cloud/soperator/busybox
            volumeMounts: [{ name: 'local-data', mountPath: /volume-mount }]
            command: ["grep", ' /volume-mount ext4 ', "/proc/mounts"]

          - name: ensure-node-local-image-storage-ext4
            image: cr.eu-north1.nebius.cloud/soperator/busybox
            volumeMounts: [{ name: 'image-storage', mountPath: /volume-mount }]
            command: ["grep", ' /volume-mount ext4 ', "/proc/mounts"]

          - name: prepare-node-local-image-storage
            image: cr.eu-north1.nebius.cloud/soperator/busybox
            volumeMounts: [{ name: 'image-storage', mountPath: /volume-mount }]
            command:
            - "sh"
            - "-c"
            - |
              mkdir -p \
                /volume-mount/enroot/cache \
                /volume-mount/enroot/data \
                /volume-mount/enroot/runtime \
                /volume-mount/docker \
              && chmod 777 -R /volume-mount/enroot /volume-mount/docker
